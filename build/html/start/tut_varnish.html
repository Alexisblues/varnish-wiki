<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Installing and Configuring Varnish &mdash; Varnish Documentation 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Varnish Documentation 0.0.1 documentation" href="../index.html" />
    <link rel="up" title="Getting Started" href="index.html" />
    <link rel="next" title="Wordpress Tutorial" href="tut_wordpress.html" />
    <link rel="prev" title="Getting Started" href="index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="tut_wordpress.html" title="Wordpress Tutorial"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Getting Started"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Varnish Documentation 0.0.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Getting Started</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="installing-and-configuring-varnish">
<span id="tut-varnish"></span><h1>Installing and Configuring Varnish<a class="headerlink" href="#installing-and-configuring-varnish" title="Permalink to this headline">¶</a></h1>
</div>
<div class="section" id="installing-varnish">
<h1>Installing VARNISH<a class="headerlink" href="#installing-varnish" title="Permalink to this headline">¶</a></h1>
<p>The following text discusses how to configure your webserver to use Varnish.
Note that the installation is different for <em>systemv</em> and <em>systemd</em>.
The following guide is for systemd as many linux distributions are now adopting to
the systemd init system.</p>
<div class="section" id="audience">
<h2>Audience:<a class="headerlink" href="#audience" title="Permalink to this headline">¶</a></h2>
<p>This reference has been prepared for web developers to get them started with
Varnish installation and configuration.</p>
<div class="section" id="step-1-installing-varnish-on-ubuntu-unix">
<h3>Step 1 : Installing Varnish on Ubuntu/UNIX:<a class="headerlink" href="#step-1-installing-varnish-on-ubuntu-unix" title="Permalink to this headline">¶</a></h3>
<p>It is recommended to install the varnish package from its repository.</p>
<ul class="simple">
<li>Start by grabbing the repository.</li>
<li>Add the repository to the source list and save.</li>
</ul>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sudo curl http://repo.varnish~cache.org/debian/GPG~key.txt <span class="p">|</span> sudo apt~key add ~

sudo nano /etc/apt/sources.list

deb http://repo.varnish~cache.org/ubuntu/ trusty varnish~4.1
</pre></div>
</div>
<ul class="simple">
<li>Run Update and Install</li>
</ul>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sudo apt~get update
sudo apt~get install varnish
</pre></div>
</div>
</div>
<div class="section" id="step-2-configure-varnish">
<h3>Step 2: Configure VARNISH<a class="headerlink" href="#step-2-configure-varnish" title="Permalink to this headline">¶</a></h3>
<p>Varnish comes with two configuration files:</p>
<p><strong>One with the starter parameter:</strong></p>
<blockquote>
<div><code class="docutils literal"><span class="pre">/etc/default/varnish</span></code></div></blockquote>
<p>This file contains all the starter parameters.</p>
<p><strong>The other is the Default VCL file:</strong></p>
<p>For systemd the VCL file is directed to in a different manner.
It will be located in:</p>
<blockquote>
<div><code class="docutils literal"><span class="pre">/etc/systemd/system/varnish.service</span></code></div></blockquote>
<p>which will point to:</p>
<blockquote>
<div><code class="docutils literal"><span class="pre">/etc/varnish/default.vcl</span></code></div></blockquote>
<p>This default.vcl contains the <em>default</em> policies that the <em>user includes</em>.
It also tells varnish where to find the web content.
However there is a <a class="reference external" href="https://github.com/varnishcache/varnish-cache/blob/master/bin/varnishd/builtin.vcl">builtin.vcl</a> which is always appended to the VCL you define/specify
in this default.vcl.</p>
<ol class="arabic">
<li><p class="first">Modify <strong>varnish</strong> config file</p>
<blockquote>
<div><ul class="simple">
<li>Open <code class="docutils literal"><span class="pre">/etc/default/varnish</span></code> in a text editor.</li>
<li>You will see a code like the one below.</li>
</ul>
</div></blockquote>
</li>
</ol>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">DAEMON</span> <span class="n">_OPTS</span><span class="o">=</span><span class="s">&quot;-a :80\</span>
<span class="s">       -T localhost:6082</span>
       <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">varnish</span><span class="o">/</span><span class="k">default</span><span class="p">.</span><span class="n">vcl</span>
       <span class="o">-</span><span class="n">S</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">varnish</span><span class="o">/</span><span class="n">secret</span>
       <span class="o">-</span><span class="n">s</span> <span class="n">malloc</span><span class="p">,</span><span class="mi">256</span><span class="n">m</span><span class="s">&quot;</span>
</pre></div>
</div>
<p>Description:</p>
<blockquote>
<div><blockquote>
<div><p>~T : refers to which port manages this.</p>
<p>~f : refers to the other configuration file containing all the default policies.
If you plan to change the name of the default policy file,
make sure to come here and change the default.vcl to the given name.</p>
<p>~S : refers to the file containing secrets such as passwords etc.</p>
<p>~s : refers to the space varnish cache is allocated. 256m”
is decided based on the current servers RAM of 1GB.</p>
</div></blockquote>
<ul class="simple">
<li>Now set the Varnish listen port to 80.</li>
<li>Now replace the <code class="docutils literal"><span class="pre">-f</span></code> line with <code class="docutils literal"><span class="pre">-b</span> <span class="pre">95.85.10.242:8080</span></code> as shown below.</li>
</ul>
</div></blockquote>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">DAEMON_OPTS</span><span class="o">=</span><span class="s">&quot;-a :80 \</span>
<span class="s">             -T localhost:6082 \</span>
<span class="s">             -b 95.85.10.242:8081 \</span>
<span class="s">             -S /etc/varnish/secret \</span>
<span class="s">             -s malloc,256m&quot;</span>

</pre></div>
</div>
<p>This is all the configuration changes in this file.</p>
<ol class="arabic" start="2">
<li><p class="first">Copy the defaults file named <strong>varnish.service</strong> file</p>
<blockquote>
<div><p><code class="docutils literal"><span class="pre">cp</span> <span class="pre">/lib/systemd/system/varnish.service</span> <span class="pre">/etc/systemd/system/</span></code></p>
<p>Edit /etc/systemd/system/varnish.service</p>
<p>Locate the line containing the port 80 and change it to 8080.</p>
<p>ExecStart=/usr/sbin/varnishd -a :80 -T localhost:6082 -f /etc/varnish/default.vcl
-S /etc/varnish/secret -s malloc,256m</p>
<p>Notice that this file points to the /etc/varnish/default.vcl file.</p>
</div></blockquote>
</li>
<li><p class="first">Now Modify <strong>default.vcl</strong> file</p>
<blockquote>
<div><p>This file contains configuration that points to the content. This is by default set to 8080
and points to host as localhost as shown below.</p>
<p>To minimally configure Varnish:</p>
<ul>
<li><p class="first">Back up default.vcl</p>
<blockquote>
<div><p><code class="docutils literal"><span class="pre">cp</span> <span class="pre">/etc/varnish/default.vcl</span> <span class="pre">/etc/varnish/default.vcl.bak</span></code></p>
</div></blockquote>
</li>
<li><p class="first">Open <code class="docutils literal"><span class="pre">/etc/varnish/default.vcl</span></code> in a text editor.</p>
</li>
<li><p class="first">Locate the following piece of code</p>
</li>
</ul>
</div></blockquote>
</li>
</ol>
<div class="highlight-bash"><div class="highlight"><pre><span></span>Backend default <span class="o">{</span>
       .host <span class="o">=</span> “127.0.0.1”<span class="p">;</span>
       .port <span class="o">=</span> “80”<span class="p">;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The value of .host by default is the localhost. It should replaces with the fully
qualified host name or IP address (typically, a webserver) and listen port of the
Varnish backend or origin server; that is, the server providing the content
Varnish will accelerate.</p>
<p>The value of .port should re replaced with webservers listening port, for example
8080 as shown below</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>Backend default <span class="o">{</span>
       .host <span class="o">=</span> “&lt;your_webserver&gt;”<span class="p">;</span>
       .port <span class="o">=</span> “8080”<span class="p">;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>It is recommended that if changes are made to these files, it should be copied and remaned name,
because when varnish updates, it will replace any changes made with it’s new default.vcl and varnish file.</p>
</div>
</div>
<div class="section" id="vcl-templates">
<h2>VCL TEMPLATEs<a class="headerlink" href="#vcl-templates" title="Permalink to this headline">¶</a></h2>
<p>~ install</p>
<div class="section" id="step-3-configure-apache2-to-work-with-varnish">
<h3>Step 3: Configure Apache2 to work with Varnish<a class="headerlink" href="#step-3-configure-apache2-to-work-with-varnish" title="Permalink to this headline">¶</a></h3>
<p>Configure your web server to listen on a port other than the default port 80 because
Varnish responds directly to incoming HTTP requests, not the web server.</p>
<p>In the sections that follow, we use port 8080 as an example as shown above.</p>
<p>To change the Apache listen port:</p>
<blockquote>
<div>~ Open /etc/apache2/ports.conf in a text editor.
~ Locate the Listen directive.
~ Change the value of the listen port to 8080. (You can use any available listen port.)
~ Save your changes to ports.conf and exit the text editor.
~ Also edit /etc/apache2/sites-available/000-default.conf
~ Change the VirtualHost port to 8080:
<cite>&lt;VirtualHost 127.0.0.1:8080&gt;</cite></div></blockquote>
</div>
<div class="section" id="step-4-restart">
<h3>Step 4: Restart<a class="headerlink" href="#step-4-restart" title="Permalink to this headline">¶</a></h3>
<p>It is always required to restart all services one changes are made in configuration files.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">service</span> <span class="n">varnish</span> <span class="n">restart</span>
<span class="n">service</span> <span class="n">apache2</span> <span class="n">restart</span>
</pre></div>
</div>
</div>
<div class="section" id="step-5-testing">
<h3>Step 5: Testing<a class="headerlink" href="#step-5-testing" title="Permalink to this headline">¶</a></h3>
<p>Run <cite>http -p Hh localhost</cite></p>
</div>
<div class="section" id="step-6-troubleshooting">
<h3>Step 6: Troubleshooting<a class="headerlink" href="#step-6-troubleshooting" title="Permalink to this headline">¶</a></h3>
<p>If Varnish fails to start, try running it from the command line as follows:</p>
<blockquote>
<div><code class="docutils literal"><span class="pre">varnishd</span> <span class="pre">~d</span> <span class="pre">~f</span> <span class="pre">/etc/varnish/default.vcl</span></code></div></blockquote>
<p>This should display the error messages.</p>
</div>
<div class="section" id="step-7-the-management-interface">
<h3>Step 7: The Management Interface<a class="headerlink" href="#step-7-the-management-interface" title="Permalink to this headline">¶</a></h3>
<p>Varnish has a command line interface (CLI) to control any varnish instance.
- It can be used to reload VCL without restarting.
- Start, stop cache process
- Change configuration parameters withour restarting.
- view upto date documentation for parameters etc.
- it can implement a list of management commands in the <cite>varnishadm</cite>
- <cite>varnishadm</cite> establishes a connection to the varnish deamon <cite>varnishd</cite></p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Installing and Configuring Varnish</a></li>
<li><a class="reference internal" href="#installing-varnish">Installing VARNISH</a><ul>
<li><a class="reference internal" href="#audience">Audience:</a><ul>
<li><a class="reference internal" href="#step-1-installing-varnish-on-ubuntu-unix">Step 1 : Installing Varnish on Ubuntu/UNIX:</a></li>
<li><a class="reference internal" href="#step-2-configure-varnish">Step 2: Configure VARNISH</a></li>
</ul>
</li>
<li><a class="reference internal" href="#vcl-templates">VCL TEMPLATEs</a><ul>
<li><a class="reference internal" href="#step-3-configure-apache2-to-work-with-varnish">Step 3: Configure Apache2 to work with Varnish</a></li>
<li><a class="reference internal" href="#step-4-restart">Step 4: Restart</a></li>
<li><a class="reference internal" href="#step-5-testing">Step 5: Testing</a></li>
<li><a class="reference internal" href="#step-6-troubleshooting">Step 6: Troubleshooting</a></li>
<li><a class="reference internal" href="#step-7-the-management-interface">Step 7: The Management Interface</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">Getting Started</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="tut_wordpress.html"
                        title="next chapter">Wordpress Tutorial</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/start/tut_varnish.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="tut_wordpress.html" title="Wordpress Tutorial"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Getting Started"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Varnish Documentation 0.0.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Getting Started</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2016, Taiyeba.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.5.
    </div>
  </body>
</html>