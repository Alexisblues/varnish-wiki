<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Understanding a Typical Website Architecture &mdash; Varnish Wiki  documentation</title>
    
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootswatch-3.3.6/cosmo/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="Varnish Wiki  documentation" href="../index.html" />
    <link rel="up" title="Getting Started" href="index.html" />
    <link rel="next" title="Resources" href="general_resources.html" />
    <link rel="prev" title="What do you want to achieve with Varnish?" href="your_varnish_goals.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          Varnish Wiki</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="https://varnish-software.com">Varnish Website</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Menu <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index.html">Varnish Web Developer&#8217;s FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content/tutorials/varnish/index.html">How to Varnish</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content/tutorials/wordpress/index.html">WordPress with Varnish</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content/tutorials/magento2/index.html">Magento2 with Varnish</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content/tutorials/drupal/index.html">Drupal with Varnish</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content/tutorials/aem.html">Adobe Experience Manager and Varnish</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content/tutorials/expressionEngine.html">Expression Engine and Varnish</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content/tutorials/sitecoreCMS.html">Sitecore CMS and Varnish</a></li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="your_varnish_goals.html" title="Previous Chapter: What do you want to achieve with Varnish?"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; What do you w...</span>
    </a>
  </li>
  <li>
    <a href="general_resources.html" title="Next Chapter: Resources"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Resources &raquo;</span>
    </a>
  </li>
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><div class="container">
    <div class="row">
      <div class="col-md-3" width="18%">
<!---        <div class="sidebar">
</div>
          <div calss="container">  --->
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h3>Contents</h3>
    <div class="sidebar-localtoc">
      <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Getting Started</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="your_varnish_goals.html">What do you want to achieve with Varnish?</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Understanding a Typical Website Architecture</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#easy-advice-on-caching-your-website">Easy Advice on Caching your website?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cookies">Cookies</a></li>
<li class="toctree-l3"><a class="reference internal" href="#edge-side-includes">Edge Side Includes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ajax-requests-on-magento">AJAX Requests on Magento</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="general_resources.html">Resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#installing-and-configuring-varnish">Installing and Configuring Varnish</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#step-by-step-configuring-for-web-applications">Step by Step Configuring for Web Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#configuring-for-enterprise-products">Configuring for Enterprise Products</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#configuring-vcl-beyond-the-default">Configuring VCL Beyond the default</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#recipes-for-cache-invalidation">Recipes for Cache Invalidation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index.html">Varnish Web Developer&#8217;s FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content/tutorials/varnish/index.html">How to Varnish</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content/tutorials/wordpress/index.html">WordPress with Varnish</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content/tutorials/magento2/index.html">Magento2 with Varnish</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content/tutorials/drupal/index.html">Drupal with Varnish</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content/tutorials/aem.html">Adobe Experience Manager and Varnish</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content/tutorials/expressionEngine.html">Expression Engine and Varnish</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content/tutorials/sitecoreCMS.html">Sitecore CMS and Varnish</a></li>
</ul>

    </div>
  </div>
</div>
<!---          </div>
        </div> --->
      </div>
    </div>
</div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="../search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
  <div class="sidebar-block">
    <div class="sidebar-wrapper">
      <h4>&nbsp;&nbsp;Contribute</h4>
      <ul class="this-page-menu">
        <li><a href="../_sources/start/website_arch.txt"
               rel="nofollow">Show Source</a></li>
        <li><a href="https://github.com/huayra/wiki_varnish/blob/master/source/start/website_arch.rst"
               rel="nofollow">Show on GitHub</a></li>
        <li><a href="https://github.com/huayra/wiki_varnish/edit/master/source/start/website_arch.rst"
               rel="nofollow">Edit on GitHub</a></li>
      </ul>
    </div>
  </div>
        </div>
      </div>
    <div class="col-md-9 content">
      
  <div class="section" id="understanding-a-typical-website-architecture">
<span id="website-arch"></span><h1>Understanding a Typical Website Architecture<a class="headerlink" href="#understanding-a-typical-website-architecture" title="Permalink to this headline">¶</a></h1>
<p>Regardless of the Web applicaiton you use to manage your wesbite, most websites
follow a similar pattern.</p>
<p>Each website has a few distinguishable sections:</p>
<ul class="simple">
<li>A front page</li>
<li>Articles or sub pages</li>
<li>A login-box</li>
<li>Static Elements like CSS, Javascript, graphics, etc</li>
</ul>
<div class="section" id="easy-advice-on-caching-your-website">
<h2>Easy Advice on Caching your website?<a class="headerlink" href="#easy-advice-on-caching-your-website" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">For static websites, Cache contents for user not logged in.</p>
</li>
<li><dl class="first docutils">
<dt>For dynamic websites,</dt>
<dd><ul class="first last simple">
<li>First you have to be able to isolate each component.</li>
<li>Then choose which component to cache.</li>
<li>Decide for how long to cache.</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>That is where varnish can really help you. Varnish assigns every single object a
TTL value. Here we discuss how each of the component can be managed separately yet
displayed together on a webpage.</p>
</div>
<div class="section" id="cookies">
<h2>Cookies<a class="headerlink" href="#cookies" title="Permalink to this headline">¶</a></h2>
<p>By default varnish does not cache a page if it has header fields from clients or
servers. The main reason for that is to avoid delivering cookie based content to
the wrong client and also to avoid bestrewing the cache with copies of the same
content.</p>
<p>Most importantly, when dealing with cookies to cache, it is discouraged to cache
anything rather then caching personal client information that could jeopardize a
client or your company if delivered to the wrong client.</p>
<p>one of our recommended VMODs for handling cookies would be <a class="reference external" href="https://download.varnish-software.com/varnish-modules/varnish4.0/libvmod-cookie-20151013.git7e453b4.tar.gz">libvmod-cookie</a> which
is available in the varnish modules repository on <a class="reference external" href="https://github.com/varnish/varnish-modules">github</a> or you can download
the whole module from the <cite>varnish website</cite> . The module also contains a <cite>vmod-header</cite>
which can be used for manipulation of duplicated HTTP headers, such as multiple
Set-Cookie headers!</p>
</div>
<div class="section" id="edge-side-includes">
<h2>Edge Side Includes<a class="headerlink" href="#edge-side-includes" title="Permalink to this headline">¶</a></h2>
<p>Edge Side Includes (ESI) helps Varnish deliver various objects together.
On a magento website, a good example of a use of ESI would be to display emerging
of new products on a top banner on a client home page or the cart.
While most of the client home page contents can be cached, the top banner and
the cart will have smaller TTL values.
Let&#8217;s say the TTL value of the banner would be about 5 minutues, the cart about
1 hour while the user page content such as name, purchased products, watching,
history would be cached for a day.</p>
</div>
<div class="section" id="ajax-requests-on-magento">
<h2>AJAX Requests on Magento<a class="headerlink" href="#ajax-requests-on-magento" title="Permalink to this headline">¶</a></h2>
<p>AJAX is of course a cool technology and developers love it.
If you are a long term magento user you probably added them to your magento site
to avoid page reloads or parts of page reloads. Of course you have already read
about ESI&#8217;s and they can do a similar task for you.</p>
<p>But if you already have AJAX on your magento site, you should know that there are
browser restrictions that doesnot allow AJAX to send requests across another doamin.
What you can do to solve this issue, is masquerade all AJAX requests. To be able
to do that you will need to add a  regular expression to masquerade the request url
in the VCL code in the <cite>vcl_recv</cite> subroutine.</p>
<div class="highlight-VCL"><div class="highlight"><pre><span></span><span class="k">sub </span><span class="nf">vcl_recv</span><span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">req.url</span> <span class="o">~</span> <span class="s">&quot;^/masq&quot;</span><span class="p">)</span> <span class="o">{</span>
        <span class="k">set</span> <span class="nv">req.backend_hint</span> <span class="o">=</span> <span class="n">google</span><span class="p">;</span>
        <span class="k">set</span> <span class="nv">req.http.host</span> <span class="o">=</span> <span class="s">&quot;www.google.com&quot;</span><span class="p">;</span>
        <span class="k">set</span> <span class="nv">req.url</span> <span class="o">=</span> <span class="k">regsub</span><span class="p">(</span><span class="nv">req.url</span><span class="o">,</span> <span class="s">&quot;^/masq&quot;</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">(</span><span class="no">hash</span><span class="p">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">set</span> <span class="nv">req.backend_hint</span> <span class="o">=</span> <span class="n">localhost</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2016, Varnish Software Group.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.5.<br/>
    </p>
  </div>
</footer>
  </body>
</html>