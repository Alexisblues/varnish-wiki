<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>STEP BY STEP GUIDE TO MAKING YOUR drupal SITE FLY &mdash; Varnish Documentation 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Varnish Documentation 0.0.1 documentation" href="../index.html" />
    <link rel="up" title="Getting Started" href="../start/index.html" />
    <link rel="next" title="Cache Invalidation with Examples" href="../intro/cache_ex.html" />
    <link rel="prev" title="Drupal Cache Invalidation" href="drupal_cache_invalidation.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../intro/cache_ex.html" title="Cache Invalidation with Examples"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="drupal_cache_invalidation.html" title="Drupal Cache Invalidation"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Varnish Documentation 0.0.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../start/index.html" accesskey="U">Getting Started</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="step-by-step-guide-to-making-your-drupal-site-fly">
<span id="drupal-step-by-step"></span><h1>STEP BY STEP GUIDE TO MAKING YOUR drupal SITE FLY<a class="headerlink" href="#step-by-step-guide-to-making-your-drupal-site-fly" title="Permalink to this headline">¶</a></h1>
<p>STEP-BY-STEP: SPEED UP drupal WITH VARNISH SOFTWARE</p>
<p>This article was originally written by Web Designer Magazine - <a class="reference external" href="http://www.webdesignermag.co.uk/">http://www.webdesignermag.co.uk/</a></p>
<p>Also Published on www.varnish-software.com by Federico G. Schwindt</p>
<p>Increase the performance of drupal using Varnish, and optimise your content-heavy sites
Nobody like to wait ages for a page to load. If your site is slow, people will go somewhere else before they can read that great article you wrote. Page speed is still an issue for many sites and recent studies show that 40 percent of users will abandon your site if it takes more than three seconds to load. this is where Varnish comes in.
Varnish is an HTTP accelerator or caching HTTP HTTP reverse proxy. It receives requests from clients and tries to answer them from the cache. If it cannot answer from the cache it will forward it to the origin server, fetch the response, store it in cache and deliver it to the client. When Varnish has a cached response ready, it is typically delivered in a matter of microseconds: two orders of magnitude faster than the average origin server, so make sure that Varnish answers as much as possible from the cache.
In this tutorial, we will go through some of the common steps required to install and configure Varnish and integrate it wil drupal to take your site to the next level. Let’s get started.</p>
<ol class="arabic simple">
<li><a class="reference internal" href="../start/tut_varnish.html#tut-varnish"><span class="std std-ref">Install Varnish</span></a></li>
</ol>
<p>Varnish packages are redily available for many Linux distributions including Red Hat, Centos, Debian and Ubuntu. In this tutorial we will assume Ubuntu 14-04.1 LTS as the underlying operative system and we’ll be installing the latest version of Varnish. For other operating systems check the latest releases on varnish-cache.org/releases. Open a command prompt and type the following as root.
apt-get install apt-transport-https</p>
<p>curl <a class="reference external" href="https://repo.varnish-cache.org/ubuntu/GPG-key.txt">https://repo.varnish-cache.org/ubuntu/GPG-key.txt</a> | apt-key add -</p>
<p>echo &#8220;deb <a class="reference external" href="https://repo.varnish-cache.org/ubuntu/">https://repo.varnish-cache.org/ubuntu/</a> trusty varnish-4.0&#8221; &amp;gt;&amp;gt; /etc/apt/sources.list.d/varnish-cache.list</p>
<p>apt-get update</p>
<p>apt-get install varnish</p>
<ol class="arabic simple" start="2">
<li>Add the plugin</li>
</ol>
<p>After installing Varnish we need to instruct drupal to purge the cached content whenever it is modified. There are several plugins to achieve this. In this tutorial we will use Varnish HTTP Purge. Go to the drupal dashboard, click on Plugins&amp;gt;Add New and search for ‘Varnish HTTP Purge’. Click on ‘Install Now’ and confirm. Finally, activate it.</p>
<ol class="arabic simple" start="3">
<li>Enable custom permalinks</li>
</ol>
<p>For the Varnish HTTP Purge plugin to work correctly we need to enable mod_rewrite and use a custom URL structure for permalinks and archives. In the drupal dashboard click on Settings&amp;gt;Permalinks and select ‘Custom Structure’. Then type /%year%/%monthnum%/%post_id% and click on ‘Save Changes’. To finalize, open a command prompt and run the following as root.
a2enmod rewrite</p>
<ol class="arabic simple" start="4">
<li>Move Apache</li>
</ol>
<p>Before we configure Varnish to handle all the web traffic to our drupal site, we will need to move Apache to a different port. Let’s then change all occurrences of port 80 with a text editor in /etc/apache2/ports.conf and any files under /etc/apache2/sites-enabled/ to 8080.</p>
<ol class="arabic simple" start="5">
<li>Serve from Varnish</li>
</ol>
<p>Now that port 80 is avaiable we can update the Varnish configuration, effectively putting it in front of Apache and drupal. On the default installation Varnish will wait for connections on port 6081. With this in mind let’s change /etc/default/varnish with a text editor and replace 6081 with 80.
DAEMON_OPTS=&#8221;-a :80 </p>
<p>-T localhost:6082 </p>
<p>-f /etc/varnish/default.vcl </p>
<p>-S /etc/varnish/secret </p>
<p>-s malloc,256m&#8221;</p>
<ol class="arabic simple" start="6">
<li>Set the backend</li>
</ol>
<p>Varnish uses the concept of backend or origin server to define where it should retrieve the content from if it’s not persistent in its cache. In this case we will be using the Apache locatio that we defined in Step 4. Edit /etc/varnish/default.vcl with a text editor and snsure the following is present.
backend default {</p>
<p>.host = &#8220;127.0.0.1&#8221;;</p>
<p>.port = &#8220;8080&#8221;;</p>
<p>}</p>
<ol class="arabic simple" start="7">
<li>Make it effective</li>
</ol>
<p>Now that all the preparations are complete we are ready to start Varnish and restart Apache. Once this is done, all traffic to our drupal site will pass through Varnish before it hits the Apache server. Open the command prompt again and run the following as root.
service varnish start
service apache2 restart</p>
<ol class="arabic simple" start="8">
<li>Ignore cookies</li>
</ol>
<p>By default. Varnish will not cache content for requests including the Cookie or header or responses including the Set-Cookie header. drupal sets many cookies that are safe to ignore during normal browsing so let’s update /etc/varnish/default.vcl and add the following inside vcl_recv to remove them.</p>
<p>set req.http.cookie = regsuball(req.http.cookie, &#8220;wp-settings-d+=[^;]+(; )?&#8221;, &#8220;&#8221;);</p>
<p>set req.http.cookie = regsuball(req.http.cookie, &#8220;wp-settings-time-d+=[^;]+(; )?&#8221;, &#8220;&#8221;);</p>
<p>set req.http.cookie = regsuball(req.http.cookie, &#8220;drupal_test_cookie=[^;]+(; )?&#8221;, &#8220;&#8221;);</p>
<p>if (req.http.cookie == &#8220;&#8221;) {</p>
<p>unset req.http.cookie;
}</p>
<ol class="arabic simple" start="9">
<li>Exclude URLs</li>
</ol>
<p>In most web applications there are some URLs that shouldn’t be cached no matter what and drupal is no exception. We will be excluding any admin or login related pages from hitting the cache. Once again open /etc/varnish/default.vcl and add the following before we remove the cookies from the previous step.
if (req.url ~ &#8220;wp-admin|wp-login&#8221;) {</p>
<p>return (pass);</p>
<p>}</p>
<ol class="arabic simple" start="10">
<li>Extend caching</li>
</ol>
<p>Varnish uses the max-age parameter in the Cache-Control HTTP header to establish how long the content is considered fresh before contacting the backend again. Varnish will use 120 seconds by default if this value is missing or is equal to zero. To extend this period to one hour we could update /etc/varnish/default.vcl.
sub vcl_backend_response {</p>
<p>if (beresp.ttl == 120s) {</p>
<p>set beresp.ttl = 1h;</p>
<div class="section" id="id1">
<h2>}<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple" start="11">
<li>Handling purge requests</li>
</ol>
<p>Whenever existing content in drupal is updated the Varnish HTTP Purge plugin will ask Varnish to remove it from the cache. The next time it’s requested, the most up-to-date version will be retrieved from the backend. But in order to do this we will need to add the following at the top of vcl_recv in /etc/varnish/default.vcl.
if (req.method == &#8220;PURGE&#8221;) {</p>
<p>if (req.http.X-Purge-Method == &#8220;regex&#8221;) {</p>
<p>ban(&#8220;req.url ~ &#8221; + req.url + &#8221; &amp;amp;&amp;amp; req.http.host ~ &#8221; + req.http.host);</p>
<p>return (synth(200, &#8220;Banned.&#8221;));</p>
<p>} else {</p>
<p>return (purge);</p>
</div>
<div class="section" id="id2">
<h2>}<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple" start="12">
<li>Secure purge</li>
</ol>
<p>In the previous step we added the necessary code to handle purge requests but we have left it open for anyone to do just that. Let’s add some code to restrict it. Edit /etc/varnish/default.vcl and after the backend add the acl below using your server IP address or hostname. Then modify the code in the previous step to use it.
acl purge {</p>
<p>&#8220;localhost&#8221;;</p>
<p>&#8220;&amp;lt;server ip address or hostname&amp;gt;&#8221;;
}</p>
<p>if (req.method == &#8220;PURGE&#8221;) {</p>
<p>if (client.ip !~ purge) {</p>
<p>return (synth(405));</p>
<p>}</p>
<ol class="arabic simple" start="13">
<li>Reload the configuration</li>
</ol>
<p>Before our changes to etc/varnish/default.vcl take effect, Varnish needs to be told to reread its configuration. To avoid any potential downtime, Varnish can be instructed to reload the configuration while it keeps serving requests. Open the command prompt again and type the following as root.
service varnish reload</p>
<ol class="arabic simple" start="14">
<li>Empty the cache</li>
</ol>
<p>Chances are that as we worked our way through the configuration, some content found its way into the cache even if it wasn’t supposed to. In this situation we can use the Varnish HTTP Plugin to empty the cache and then we can start afresh. Go to the drupal dashboard and click on Purge Varnish at the very top.</p>
<ol class="arabic simple" start="15">
<li>Examine the traffic</li>
</ol>
<p>Everything is working; browse some pages, login, logout, pages are loading fast. Or are they? Varnish comes with a set of tools that will help you understand what’s going on behind the scenes and debug any potential problems. To see the requests as they are passing through Varnish run the following on a command prompt:
varnishlog</p>
<ol class="arabic simple" start="16">
<li>Volume matcher/measure</li>
</ol>
<p>Varnish is very powerful but can be daunting at first. Luckily for us there are many resources online and has an active community behind ready to help. If you are stuck or want to know more you can visit the Varnish website at varnish-cache.org.</p>
<ol class="arabic simple" start="17">
<li>Go further</li>
</ol>
<p>If you are interested in Varnish, you can always give Varnish Plus a go. There’s a free trial available. You can capture real-time traffic statistics, create a paywall for premium content, simultaniously work on administration across all Varnish servers, record relationships between web pages for easy content maintenance, detect devices used for browsing, and accelerate APIs.</p>
<p>Check out the links below to take Varnish even further.</p>
<div class="toctree-wrapper compound">
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">STEP BY STEP GUIDE TO MAKING YOUR drupal SITE FLY</a><ul>
<li><a class="reference internal" href="#id1">}</a></li>
<li><a class="reference internal" href="#id2">}</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="drupal_cache_invalidation.html"
                        title="previous chapter">Drupal Cache Invalidation</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../intro/cache_ex.html"
                        title="next chapter">Cache Invalidation with Examples</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/drupal/drupal_step_by_step.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../intro/cache_ex.html" title="Cache Invalidation with Examples"
             >next</a> |</li>
        <li class="right" >
          <a href="drupal_cache_invalidation.html" title="Drupal Cache Invalidation"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Varnish Documentation 0.0.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../start/index.html" >Getting Started</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2016, Taiyeba.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.5.
    </div>
  </body>
</html>