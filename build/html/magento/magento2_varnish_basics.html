<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Basics on Magento 2 and Varnish &mdash; Varnish Documentation 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Varnish Documentation 0.0.1 documentation" href="../index.html" />
    <link rel="up" title="Varnish with Magento" href="index.html" />
    <link rel="next" title="Top 5 Magento Plugins we Recommend" href="top5_magento_plugins.html" />
    <link rel="prev" title="Caching in Magento 2" href="magento2_ce.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="top5_magento_plugins.html" title="Top 5 Magento Plugins we Recommend"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="magento2_ce.html" title="Caching in Magento 2"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Varnish Documentation 0.0.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../start/index.html" >Getting Started</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Varnish with Magento</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="basics-on-magento-2-and-varnish">
<span id="magento2-varnish-basics"></span><h1>Basics on Magento 2 and Varnish<a class="headerlink" href="#basics-on-magento-2-and-varnish" title="Permalink to this headline">¶</a></h1>
<p>This chapter is mainly written for web developers who want to get a clear idea
about the basics of varnish with magento.</p>
<p>Varnish as you may already know is designed for HTTP semantics and will soon be
available for HTTP/2.0. The new version of HTTP/2 has been released under <a class="reference external" href="https://www.rfc-editor.org/rfc/rfc7540.txt">RFC 7540</a>.
However one must know that HTTP/2.0 is an alternative to HTTP/1.1 and doesnot
outmode HTTP/1.0.</p>
<p>What this protocol allows for any given website is to sent multiple requests in
serial mode over a single connection so that when a single client wants to fetch
several resources in paralell, it can just open several connections to fetch from
a single webserver.</p>
<p>Now imagine multiple customers trying to order several products in paralell from
a single magento webserver. The overhead this may cause is quite vast.
Which is why varnish is here to save the day!</p>
<p>To learn more about the basics of HTTP visit <a class="reference external" href="http://book.varnish-software.com/4.0/chapters/HTTP.html#resources-and-representations">HTTP Basics</a> at the <cite>Varnish Software website</cite>.</p>
<p>You also need to be clear about what you want varnish to do for your website.
To read more analyzing and understadning your website, as yourself the following questions:</p>
<ul class="simple">
<li>What makes the pages on your magento website different from each other?</li>
<li>Do differences apply to entire pages or just part of them?</li>
<li>How shall i inform varnish of the differences?</li>
</ul>
<p>TO answer all your questions, follow the link to our varnish book discussing
<a class="reference external" href="http://book.varnish-software.com/4.0/chapters/Content_Composition.html">Content Composition</a> .</p>
<p>As you will see, Varnish can help manage your magento website in more then one way.
Varnish can help your webservers with load balancing, firewalls, file compressions,
cookie management, etc.</p>
<p>A better in-site on some of these Varnish characteristics would be to get to know
our product Varnish Cache a little better. Varnish cache as the name suggests
allows caching of resources. This mechanism is enhanced to allow multiple
identical requests from different clients to have the
same effect on a single request called the idempotency.But do not worry!</p>
<p>Varnish cache if configured properly doesnot cache <cite>everything</cite>! Infact you can
decide what to cache, how to cache when to cache. To be able to better manage
the cache headers, one must understand the <cite>cache related header fields of HTTP</cite>.
Varnish uses these rfc7232 and these rfc7234 cache header fields to decide which
objects to cache.</p>
<p>If a matched cache is valid then varnish retrieves responses from the cache.
This reduces the load of the origin server further more (apart from varnishes
load balancing capacities) from managing similar responses multiple times.</p>
<div class="section" id="so-when-does-varnish-serve-the-cached-objects">
<h2>So when does Varnish serve the cached objects?<a class="headerlink" href="#so-when-does-varnish-serve-the-cached-objects" title="Permalink to this headline">¶</a></h2>
<p>In simple terms, varnish serves cache contents based on three things:</p>
<ol class="arabic simple">
<li>Cache Matching</li>
<li>Allowance</li>
<li>Freshess of Data</li>
</ol>
<div class="section" id="cache-matching">
<h3>1. Cache Matching<a class="headerlink" href="#cache-matching" title="Permalink to this headline">¶</a></h3>
<p>The cached object is properly matched. In such a case it is called <cite>cache-hit</cite>.
A proper example of a cached object on a Magento site would be common product
descriptions, but not the price! Because price may vary over time.
A cache-hit object is served without contacting the origin server. However if the
object requested is not in cache then it&#8217;s <cite>cache-miss</cite> and in this case varnish
forwards this request to the origin serer.</p>
</div>
<div class="section" id="allowance">
<h3>2. Allowance<a class="headerlink" href="#allowance" title="Permalink to this headline">¶</a></h3>
<p>As mentioned in the varnish book, Allowance is validating the <cite>cache-hit</cite>.
Varnish further has an option for a user to choose how long an object should be in
cache and when to serve from the cache and when not-to. If a cached object should
be reserved or not. This validation process is done by checking whether the
request contains the <cite>no-cache</cite> directive. In such a cache the HTTP cache-control
header is checked for the presence of <cite>no-cache</cite>.</p>
<p>Read more about the <a class="reference external" href="http://book.varnish-software.com/4.0/chapters/HTTP.html#cache-control">cache-control header</a> on the varnish book.</p>
</div>
<div class="section" id="freshness-of-data">
<h3>3.Freshness of Data<a class="headerlink" href="#freshness-of-data" title="Permalink to this headline">¶</a></h3>
<p>When deciding whether to use a cached object i.e whether to <cite>allow</cite>
it, checking the freshness of the data and evaluating whether to deliver an
expired object or not is the question.</p>
<p>There are two kinds of objects:</p>
<p><cite>fresh objects</cite> - age has not exceeded the freshness lifetime
<cite>stale objects</cite> - age has exceeded the freshness lifetime i.e. it is now an
<cite>expired object</cite>.</p>
<p>To read more about how the freshness of an object is determined visit the
varnish book, <a class="reference external" href="http://book.varnish-software.com/4.0/chapters/HTTP.html#freshness">Freshness</a> section.</p>
<p>Now let&#8217;s move on to understanding the Caching system in Magento 2.</p>
</div>
</div>
<div class="section" id="caching-in-magento-2">
<span id="magento2-ce"></span><h2>Caching in Magento 2<a class="headerlink" href="#caching-in-magento-2" title="Permalink to this headline">¶</a></h2>
<p>Magento 2 with its great abilities is the next generation open source digital
commerce platform. A large number of websites use magento and with magento 2
the server performance has boosted to a new level.</p>
<div class="section" id="so-why-does-magento-2-require-varnish-caching">
<h3>So why does Magento 2 require varnish caching?<a class="headerlink" href="#so-why-does-magento-2-require-varnish-caching" title="Permalink to this headline">¶</a></h3>
<p>Magento websites are expected to have large amount of traffic. For the website
to fly varnish cache provides a caching mechanism that not only helps with
caching but also provides other services that enables magento webservers to
provide excellent services to clients.</p>
</div>
</div>
<div class="section" id="cache-extensions">
<h2>Cache Extensions<a class="headerlink" href="#cache-extensions" title="Permalink to this headline">¶</a></h2>
<p>Magento has two Cache extensions;</p>
<ul class="simple">
<li>The internal cache (filesystem)</li>
<li>The external cache (varnish!)</li>
</ul>
<p>Here we will mainly talk about Varnish, the external cache.</p>
<p>As you may already know Magento 2 supports varnish out of the box.
The varnish cache is installed as an independent component. It serves as an
intermediate between the webservers running magento and the backened memory.</p>
<p>Varnish cache on a magento 2 site caches all/if any static pages and also parts
of dynamic pages.</p>
<div class="section" id="cookies">
<h3>Cookies<a class="headerlink" href="#cookies" title="Permalink to this headline">¶</a></h3>
<p>By default varnish does not cache a page if it has header fields from clients or
servers. The main reason for that is to avoid delivering cookie based content to
the wrong client and also to avoid bestrewing the cache with copies of the same
content.</p>
<p>Most importantly, when dealing with cookies to cache, it is discouraged to cache
anything rather then caching personal client information that could jeopardize a
client or your company if delivered to the wrong client.</p>
<p>one of our recommended VMODs for handling cookies would be <a class="reference external" href="https://download.varnish-software.com/varnish-modules/varnish4.0/libvmod-cookie-20151013.git7e453b4.tar.gz">libvmod-cookie</a> which
is available in the varnish modules repository on <a class="reference external" href="https://github.com/varnish/varnish-modules">github</a> or you can download
the whole module from the <cite>varnish website</cite> . The module also contains a <cite>vmod-header</cite>
which can be used for manipulation of duplicated HTTP headers, such as multiple
Set-Cookie headers!</p>
</div>
<div class="section" id="edge-side-includes">
<h3>Edge Side Includes<a class="headerlink" href="#edge-side-includes" title="Permalink to this headline">¶</a></h3>
<p>Edge Side Includes (ESI) helps Varnish deliver various objects together.
On a magento website, a good example of a use of ESI would be to display emerging
of new products on a top banner on a client home page or the cart.
While most of the client home page contents can be cached, the top banner and
the cart will have smaller TTL values.
Let&#8217;s say the TTL value of the banner would be about 5 minutues, the cart about
1 hour while the user page content such as name, purchased products, watching,
history would be cached for a day.</p>
</div>
<div class="section" id="ajax-requests-on-magento">
<h3>AJAX Requests on Magento<a class="headerlink" href="#ajax-requests-on-magento" title="Permalink to this headline">¶</a></h3>
<p>AJAX is of course a cool technology and developers love it.
If you are a long term magento user you probably added them to your magento site
to avoid page reloads or parts of page reloads. Of course you have already read
about ESI&#8217;s and they can do a similar task for you.</p>
<p>But if you already have AJAX on your magento site, you should know that there are
browser restrictions that doesnot allow AJAX to send requests across another doamin.
What you can do to solve this issue, is masquerade all AJAX requests. To be able
to do that you will need to add a  regular expression to masquerade the request url
in the VCL code in the <cite>vcl_recv</cite> subroutine.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">sub</span> <span class="n">vcl_recv</span><span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">url</span> <span class="o">~</span> <span class="s">&quot;^/masq&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">set</span> <span class="n">req</span><span class="p">.</span><span class="n">backend_hint</span> <span class="o">=</span> <span class="n">google</span><span class="p">;</span>
        <span class="n">set</span> <span class="n">req</span><span class="p">.</span><span class="n">http</span><span class="p">.</span><span class="n">host</span> <span class="o">=</span> <span class="s">&quot;www.google.com&quot;</span><span class="p">;</span>
        <span class="n">set</span> <span class="n">req</span><span class="p">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">regsub</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="s">&quot;^/masq&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">hash</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">set</span> <span class="n">req</span><span class="p">.</span><span class="n">backend_hint</span> <span class="o">=</span> <span class="n">localhost</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="cache-invalidation">
<span id="id1"></span><h2>Cache Invalidation<a class="headerlink" href="#cache-invalidation" title="Permalink to this headline">¶</a></h2>
<p>Firstly to cache or not to cache. But once you decide to cache, cache invalidation
becomes an important part of your cache policy. the good news is Varnish automatically
invalidates expired objects for you. But you also have the advantage of taking charge
of invalidating your websites cached objects.</p>
<p>The easiest but not recommended way to invalidate cache is to assign small TTL
values to cached objects. This would simply expire cached contents quickly.</p>
<p>Just changing the ttl value in the <cite>vcl_fetch</cite> would speed up invalidation and
return more fresh contents such as the code below:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>``sub vcl_fetch {``
</pre></div>
</div>
<blockquote>
<div><code class="docutils literal"><span class="pre">set</span> <span class="pre">beresp.ttl</span> <span class="pre">=</span> <span class="pre">5s;</span></code></div></blockquote>
<p><code class="docutils literal"><span class="pre">}</span></code></p>
<p>This sets the ttl to 5seconds, thus varnish picks up Magento changes every 5sec.</p>
<p>However, it is known that the most effective way of increasing a websites hit
ratio is to increase the time-to-live (ttl) of the objects. Therefore there is
more to the caching process then just the ttl value.</p>
<p>Another alternative could be to validate cached contents per request.</p>
<p>These alternatives can cause issues, as this creates higher load on the application
server.</p>
<p>However with Varnish, there are four mechanisms to invalidate caches.</p>
<div class="section" id="http-purge">
<h3>1. HTTP Purge<a class="headerlink" href="#http-purge" title="Permalink to this headline">¶</a></h3>
<p>HTTP Purging is very straight forward. With the use of Varnish VCL subroutine
<cite>vcl_purge</cite>, Varnish will discard the object from the cache and free up memory.
A restart would immediately update the purged object.</p>
</div>
<div class="section" id="banning">
<h3>2. Banning<a class="headerlink" href="#banning" title="Permalink to this headline">¶</a></h3>
<p>Bans can be implemented for objects that are known to frequently change.
In such a case, certain contents are banned to be retrieved from the cache based
on the meta data. The ban is quite a reliable method, as it only works for
objects in the cache but doesnot interfere with new content being cached or
served.</p>
</div>
<div class="section" id="forcing-a-cache-miss">
<h3>3. Forcing a Cache Miss<a class="headerlink" href="#forcing-a-cache-miss" title="Permalink to this headline">¶</a></h3>
<p>This mechanism is similar to flusing the entire cache,
as in it follows the procedure that when an object is not found in the cache
it is served from the backend. But it also very much like Bans.</p>
<p>However <em>cache miss</em> is more reliable as it this is forced and very much like
refreshing a page. This method refreshes an object by forcing a cache miss for a
request. Thus enabling a force fetch from the backend and overriding the current
one. But the old object does remain in the cache until its ttl expires.</p>
</div>
<div class="section" id="hashtwo-xkey">
<h3>4. Hashtwo / Xkey<a class="headerlink" href="#hashtwo-xkey" title="Permalink to this headline">¶</a></h3>
<p>The hashtwo or xkey is for websites requiring large scale caching.</p>
</div>
</div>
</div>
<div class="section" id="more-about-caching">
<h1>More about Caching<a class="headerlink" href="#more-about-caching" title="Permalink to this headline">¶</a></h1>
<div class="section" id="connect-to-varnishadm">
<h2>Connect to Varnishadm<a class="headerlink" href="#connect-to-varnishadm" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="purge-call">
<h2>Purge call<a class="headerlink" href="#purge-call" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="purge-call-to-x-headers">
<h2>Purge call to X-Headers<a class="headerlink" href="#purge-call-to-x-headers" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="more-caching-resources">
<h2>More Caching Resources<a class="headerlink" href="#more-caching-resources" title="Permalink to this headline">¶</a></h2>
<p>To get a better and more in-depth overview of our cache invalidation process,
a recommended read is the article by <a class="reference external" href="https://www.smashingmagazine.com/2014/04/cache-invalidation-strategies-with-varnish-cache/">Per Buer on Cache Invalidation at Smash Magazine</a></p>
<p>There is also a great comparison table in The Varnish Book - <a class="reference external" href="http://book.varnish-software.com/4.0/chapters/Cache_Invalidation.html">Cache Invalidation</a></p>
<p>More about <a class="reference external" href="https://info.varnish-software.com/blog/advanced-cache-invalidation-strategies">Advanced Cache Invalidation Techniques</a></p>
<p>Remember that varnish has a lot of resources and but if you have any questions
please feel free to contact us.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Basics on Magento 2 and Varnish</a><ul>
<li><a class="reference internal" href="#so-when-does-varnish-serve-the-cached-objects">So when does Varnish serve the cached objects?</a><ul>
<li><a class="reference internal" href="#cache-matching">1. Cache Matching</a></li>
<li><a class="reference internal" href="#allowance">2. Allowance</a></li>
<li><a class="reference internal" href="#freshness-of-data">3.Freshness of Data</a></li>
</ul>
</li>
<li><a class="reference internal" href="#caching-in-magento-2">Caching in Magento 2</a><ul>
<li><a class="reference internal" href="#so-why-does-magento-2-require-varnish-caching">So why does Magento 2 require varnish caching?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cache-extensions">Cache Extensions</a><ul>
<li><a class="reference internal" href="#cookies">Cookies</a></li>
<li><a class="reference internal" href="#edge-side-includes">Edge Side Includes</a></li>
<li><a class="reference internal" href="#ajax-requests-on-magento">AJAX Requests on Magento</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cache-invalidation">Cache Invalidation</a><ul>
<li><a class="reference internal" href="#http-purge">1. HTTP Purge</a></li>
<li><a class="reference internal" href="#banning">2. Banning</a></li>
<li><a class="reference internal" href="#forcing-a-cache-miss">3. Forcing a Cache Miss</a></li>
<li><a class="reference internal" href="#hashtwo-xkey">4. Hashtwo / Xkey</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#more-about-caching">More about Caching</a><ul>
<li><a class="reference internal" href="#connect-to-varnishadm">Connect to Varnishadm</a></li>
<li><a class="reference internal" href="#purge-call">Purge call</a></li>
<li><a class="reference internal" href="#purge-call-to-x-headers">Purge call to X-Headers</a></li>
<li><a class="reference internal" href="#more-caching-resources">More Caching Resources</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="magento2_ce.html"
                        title="previous chapter">Caching in Magento 2</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="top5_magento_plugins.html"
                        title="next chapter">Top 5 Magento Plugins we Recommend</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/magento/magento2_varnish_basics.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="top5_magento_plugins.html" title="Top 5 Magento Plugins we Recommend"
             >next</a> |</li>
        <li class="right" >
          <a href="magento2_ce.html" title="Caching in Magento 2"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Varnish Documentation 0.0.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../start/index.html" >Getting Started</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Varnish with Magento</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2016, Taiyeba.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.4.
    </div>
  </body>
</html>