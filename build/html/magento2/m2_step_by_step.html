<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>STEP BY STEP GUIDE TO MAKING YOUR MAGENTO SITE FLY &mdash; Varnish Documentation 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Varnish Documentation 0.0.1 documentation" href="../index.html" />
    <link rel="up" title="Getting Started" href="../start/index.html" />
    <link rel="next" title="Caching in Magento 2" href="magento2_ce.html" />
    <link rel="prev" title="Magento2 Tutorial" href="../start/tut_magento2.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="magento2_ce.html" title="Caching in Magento 2"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../start/tut_magento2.html" title="Magento2 Tutorial"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Varnish Documentation 0.0.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../start/index.html" accesskey="U">Getting Started</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="step-by-step-guide-to-making-your-magento-site-fly">
<span id="m2-step-by-step"></span><h1>STEP BY STEP GUIDE TO MAKING YOUR MAGENTO SITE FLY<a class="headerlink" href="#step-by-step-guide-to-making-your-magento-site-fly" title="Permalink to this headline">¶</a></h1>
<p>Ofcourse you want to get started with increasing the performance of your website!
So Lets get Started!</p>
<div class="section" id="installing-magento-from-the-magento-site">
<h2>1. Installing Magento from the <a class="reference external" href="http://devdocs.magento.com/guides/v2.1/install-gde/bk-install-guide.html">Magento-Site</a><a class="headerlink" href="#installing-magento-from-the-magento-site" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="installing-varnish">
<h2>2. <a class="reference internal" href="../start/tut_varnish.html#tut-varnish"><span class="std std-ref">Installing Varnish</span></a><a class="headerlink" href="#installing-varnish" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="how-to-place-magento-2-behind-varnish">
<h2>3. How to place Magento 2 behind Varnish<a class="headerlink" href="#how-to-place-magento-2-behind-varnish" title="Permalink to this headline">¶</a></h2>
<p>Here we discuss how to configure your Magento2 behind Varnish.</p>
<p>The Magento2 Admin states that built-in Application cache is not recommended for production use, but that doesnot mean that varnish is configured. Varnish needs to be installed and the configuration file suitably configured and deployed.</p>
<p>We assume that you have Magento2 installed and running on your backend servers and that your server is a Debian based Linux Server.</p>
<div class="section" id="configuring-magento">
<h3>Configuring Magento<a class="headerlink" href="#configuring-magento" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">Visit the Magento 2 Admin page and go to:</p>
<blockquote>
<div><p>-&gt; Stores</p>
<p>-&gt; Advanced</p>
<p>-&gt; System</p>
<p>-&gt; Full Page Cache</p>
<p>here switch caching application to <strong>Varnish</strong></p>
</div></blockquote>
</li>
<li><p class="first">Configuring for Varnish</p>
</li>
</ol>
<ul class="simple">
<li>Under the Additional section, find a button for exporting the ready-made configuration file for varnish 3 or 4. We recommned you used varnish 4.0 now.</li>
</ul>
<dl class="docutils">
<dt>Therefore click on::</dt>
<dd>-&gt; Export VCL for Varnish 4
this is usually named varnish.vcl</dd>
</dl>
<p>Place the file in a varnish folder for configuration (any safe place for you).</p>
<ul class="simple">
<li>Next to add varnish repository follow the instructions over at <cite>Install Varnish &lt;install_varnish&gt;</cite></li>
</ul>
<ol class="arabic simple" start="3">
<li>Testing your set up</li>
</ol>
<p>Now to check if your services are up and running:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>``$ ps -e | grep &#39;apache2|varnish&#39;``
</pre></div>
</div>
<p>If you recieve outputs like the ones below:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>1143 ?        00:00:03 varnishd
1148 ?        00:00:17 varnishd
1366 ?        00:02:02 varnishlog
1591 ?        00:00:01 apache2
11743 ?        00:00:10 apache2
11744 ?        00:00:10 apache2
</pre></div>
</div>
<p>Congratulations! You have your services running on the backend.</p>
<p>Now we need to check the Magento2 frontend::
As you may have already noticed above, there is a <code class="docutils literal"><span class="pre">varnishlog</span></code> process running as well.</p>
<p>If you are interested in trying out an installation try downloading Marko&#8217;s Vagrant Box <a class="reference external" href="https://github.com/Marko-M/magento2-vagrant-nux">marko_magento2github</a>.
His installation used niginx with varnish and magento.You can also read more about that at Marko&#8217;s blogpost about Placing Magento2 behind Varnish
<a class="reference external" href="http://www.techytalk.info/magento-2-behind-varnish-reverse-proxy/">marko_magento2post</a>.</p>
</div>
</div>
<div class="section" id="restart-services-after-making-changes">
<h2>4. Restart services after making changes<a class="headerlink" href="#restart-services-after-making-changes" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">varnish</span><span class="p">.</span><span class="n">service</span>

<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">apache2</span><span class="p">.</span><span class="n">service</span>
</pre></div>
</div>
</div>
<div class="section" id="basic-caching">
<h2>5. Basic Caching<a class="headerlink" href="#basic-caching" title="Permalink to this headline">¶</a></h2>
<p>Varnish doesnot cache cookies or its headers. But some cookies are marked as safe
by the magento site. Therefore it is recommended to remove or ignore these cookies
so that varnish can cache anything.</p>
<p>An example like the following will help to unset/remove unwanted cookies.</p>
<p>Update your <cite>default.vcl</cite> with this code or a similar code of your choice.</p>
<p>Under the <cite>vcl_recv</cite> add the following code.</p>
<p>warning: Make sure to add the code below the default code given for <cite>vcl_recv</cite></p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">sub</span> <span class="n">vcl_recv</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">http</span><span class="p">.</span><span class="n">cookie</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">set</span> <span class="n">req</span><span class="p">.</span><span class="n">http</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="s">&quot;;&quot;</span> <span class="o">+</span> <span class="n">req</span><span class="p">.</span><span class="n">http</span><span class="p">.</span><span class="n">cookie</span><span class="p">;</span>
    <span class="n">set</span> <span class="n">req</span><span class="p">.</span><span class="n">http</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">regsuball</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">http</span><span class="p">.</span><span class="n">cookie</span><span class="p">,</span> <span class="s">&quot;; +&quot;</span><span class="p">,</span> <span class="s">&quot;;&quot;</span><span class="p">);</span>
    <span class="n">set</span> <span class="n">req</span><span class="p">.</span><span class="n">http</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">regsuball</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">http</span><span class="p">.</span><span class="n">cookie</span><span class="p">,</span> <span class="s">&quot;;(COOKIE1|COOKIE2|COOKIE3)=&quot;</span><span class="p">,</span> <span class="s">&quot;; </span><span class="se">\1</span><span class="s">=&quot;</span><span class="p">);</span>
    <span class="n">set</span> <span class="n">req</span><span class="p">.</span><span class="n">http</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">regsuball</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">http</span><span class="p">.</span><span class="n">cookie</span><span class="p">,</span> <span class="s">&quot;;[^ ][^;]*&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="n">set</span> <span class="n">req</span><span class="p">.</span><span class="n">http</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">regsuball</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">http</span><span class="p">.</span><span class="n">cookie</span><span class="p">,</span> <span class="s">&quot;^[; ]+|[; ]+$&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">http</span><span class="p">.</span><span class="n">cookie</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">remove</span> <span class="n">req</span><span class="p">.</span><span class="n">http</span><span class="p">.</span><span class="n">cookie</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

</pre></div>
</div>
</div>
<div class="section" id="excluding-certain-urls">
<h2>6. Excluding certain URLs<a class="headerlink" href="#excluding-certain-urls" title="Permalink to this headline">¶</a></h2>
<p>Not all URLs should be cached. Especially not in sites that deal with personal
information such as credit card information.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">url</span> <span class="o">~</span> <span class="s">&quot;magento_admin|magento_login&quot;</span><span class="p">)</span> <span class="p">{</span>

<span class="k">return</span> <span class="p">(</span><span class="n">pass</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="extended-caching">
<h2>7. Extended Caching<a class="headerlink" href="#extended-caching" title="Permalink to this headline">¶</a></h2>
<p>There is a subroutine called <em>vcl_fetch</em> which is by default set to 120 seconds as can be seen.
You can extend this caching value by</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">sub</span> <span class="n">vcl_fetch</span> <span class="p">{</span>
       <span class="n">set</span> <span class="n">beresp</span><span class="p">.</span><span class="n">ttl</span> <span class="o">=</span> <span class="mi">5</span><span class="n">s</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This sets the ttl to 5 seconds, thus varnish picks up changes every 5sec.
Add this subroutine right below the <em>backend default</em>.</p>
<p>However, there is a downside to short TTL values that is they increase the load
not only in the backend servers but also the front end servers. Of course this
gives you a better control over your cache, but it also increases overheads such
as network traffic, response times becomes slower thus diminishing the whole
purpose of varnish.</p>
<p>So decreasing TTL values is not a good solution for high traffic based servers.
Varnish has a better solution for that.</p>
<p>Read more about caching at <a class="reference internal" href="magento2_ce.html#magento2-ce"><span class="std std-ref">Caching with Magento 2</span></a></p>
</div>
<div class="section" id="specific-ttl-based-caching">
<h2>8. Specific TTL Based Caching<a class="headerlink" href="#specific-ttl-based-caching" title="Permalink to this headline">¶</a></h2>
<p>Varnish creates a TTL value for every object in the cache. A most effective way
of increasing a websites hit ratio is to increase the time-to-live (ttl) of the
objects.</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="magento2_ce.html">Caching in Magento 2</a><ul>
<li class="toctree-l2"><a class="reference internal" href="magento2_ce.html#so-why-does-magento-2-require-varnish-caching">So why does Magento 2 require varnish caching?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="magento2_ce.html#cache-extensions">Cache Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../start/tut_varnish.html">Installing and Configuring Varnish</a></li>
<li class="toctree-l1"><a class="reference internal" href="../start/tut_varnish.html#installing-varnish">Installing VARNISH</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../start/tut_varnish.html#audience">Audience:</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../start/tut_varnish.html#step-1-installing-varnish-on-ubuntu-unix">Step 1 : Installing Varnish on Ubuntu/UNIX:</a></li>
<li class="toctree-l3"><a class="reference internal" href="../start/tut_varnish.html#step-2-configure-varnish">Step 2: Configure VARNISH</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../start/tut_varnish.html#vcl-templates">VCL TEMPLATEs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../start/tut_varnish.html#step-3-configure-apache2-to-work-with-varnish">Step 3: Configure Apache2 to work with Varnish</a></li>
<li class="toctree-l3"><a class="reference internal" href="../start/tut_varnish.html#step-4-restart">Step 4: Restart</a></li>
<li class="toctree-l3"><a class="reference internal" href="../start/tut_varnish.html#step-5-testing">Step 5: Testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../start/tut_varnish.html#step-6-troubleshooting">Step 6: Troubleshooting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../start/tut_varnish.html#step-7-the-management-interface">Step 7: The Management Interface</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">STEP BY STEP GUIDE TO MAKING YOUR MAGENTO SITE FLY</a><ul>
<li><a class="reference internal" href="#installing-magento-from-the-magento-site">1. Installing Magento from the Magento-Site</a></li>
<li><a class="reference internal" href="#installing-varnish">2. <code class="docutils literal"><span class="pre">Installing</span> <span class="pre">Varnish</span></code></a></li>
<li><a class="reference internal" href="#how-to-place-magento-2-behind-varnish">3. How to place Magento 2 behind Varnish</a><ul>
<li><a class="reference internal" href="#configuring-magento">Configuring Magento</a></li>
</ul>
</li>
<li><a class="reference internal" href="#restart-services-after-making-changes">4. Restart services after making changes</a></li>
<li><a class="reference internal" href="#basic-caching">5. Basic Caching</a></li>
<li><a class="reference internal" href="#excluding-certain-urls">6. Excluding certain URLs</a></li>
<li><a class="reference internal" href="#extended-caching">7. Extended Caching</a></li>
<li><a class="reference internal" href="#specific-ttl-based-caching">8. Specific TTL Based Caching</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="../start/tut_magento2.html"
                        title="previous chapter">Magento2 Tutorial</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="magento2_ce.html"
                        title="next chapter">Caching in Magento 2</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/magento2/m2_step_by_step.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="magento2_ce.html" title="Caching in Magento 2"
             >next</a> |</li>
        <li class="right" >
          <a href="../start/tut_magento2.html" title="Magento2 Tutorial"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Varnish Documentation 0.0.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../start/index.html" >Getting Started</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2016, Taiyeba.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.5.
    </div>
  </body>
</html>